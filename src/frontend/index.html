<!DOCTYPE html>
<html lang="en">
<head>
    <title>Dashboard</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: Arial, sans-serif;
        }

        /* Header */
        .header { 
            width: 100%;
            height: 200px;
            background-color: lightblue;
            color: white;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 20px;
            position: fixed;
            top: 0;
            left: 0;
        }

        /* Content */
        .content {
            margin-top: 220px;
            padding: 50px;
            background-color: white;
            color: black;
        }

        footer {
            text-align: center;
            padding: 15px;
            background-color: black;
            color: white;
            position: fixed;
            bottom: 0;
            width: 100%;
        }
    </style>

    <link rel="stylesheet" href="css/styles.css">
</head>

<body style="background-color:White;">
    
    <div class="header">
        <h2>Dashboard</h2>
        <nav>
            <a href="/alerts" style="color: white; margin: 0 15px;">Alerts</a>
            <a href="#" style="color: white; margin: 0 15px;">Settings</a>
        </nav>
    </div>
    <div class="content">
        <h1>Graph 1: BPM</h1>
        <canvas id="bpmChart" style="width:100%;max-width:700px"></canvas>
        
        <h1>Graph 2: SpO2</h1>
        <canvas id="spo2Chart" style="width:100%;max-width:700px"></canvas>
        
        <h1>Graph 3: ECG</h1>
        <canvas id="ecgChart" style="width:100%;max-width:700px"></canvas>
    </div>
   
    <footer>
        <p>Footer goes here <br> © 2025. Blah Blah All rights reserved.</p>
    </footer>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.9.4/Chart.js"></script>

    <script>
        // Keep these arrays alive across fetches
        const maxPoints = 24;
        let timeData = [];
        let bpmData  = [];
        let spo2Data = [];
        let ecgData  = [];
      
        let bpmChartInstance = null;
        let spo2ChartInstance = null;
        let ecgChartInstance = null;
      
        async function fetchDataAndUpdateChart() {
          try {
            const patientData = JSON.parse(localStorage.getItem("patient"));
            const token       = patientData?.access_token;
            if (!token) {
              console.error("No access token found");
              return;
            }
      
            const response = await fetch('http://127.0.0.1:5000/api/vitals/', {
              headers: { 'Authorization': 'Bearer ' + token }
            });
            if (!response.ok) throw new Error(`HTTP ${response.status}`);
      
            const { timestamp, bpm, spo2, ecg } = await response.json();
      
            // Push new values onto the arrays
            timeData.push(timestamp);
            bpmData.push(bpm);
            spo2Data.push(spo2);
            ecgData.push(ecg);
      
            // Trim arrays to maxPoints
            if (timeData.length  > maxPoints) timeData.shift();
            if (bpmData.length   > maxPoints) bpmData.shift();
            if (spo2Data.length  > maxPoints) spo2Data.shift();
            if (ecgData.length   > maxPoints) ecgData.shift();
      
            // Re‑draw charts
            if (bpmChartInstance)  bpmChartInstance.destroy();
            if (spo2ChartInstance) spo2ChartInstance.destroy();
            if (ecgChartInstance)  ecgChartInstance.destroy();
      
            bpmChartInstance = new Chart("bpmChart", {
              type: "line",
              data: {
                labels: timeData,
                datasets: [{ label: "BPM", data: bpmData, fill: false, lineTension: 0.1 }]
              },
              options: { scales: { yAxes: [{ ticks: { min: 50, max: 110 }}] } }
            });
      
            spo2ChartInstance = new Chart("spo2Chart", {
              type: "line",
              data: {
                labels: timeData,
                datasets: [{ label: "SpO2 (%)", data: spo2Data, fill: false, lineTension: 0.1 }]
              },
              options: { scales: { yAxes: [{ ticks: { min: 90, max: 100 }}] } }
            });
      
            ecgChartInstance = new Chart("ecgChart", {
              type: "line",
              data: {
                labels: timeData,
                datasets: [{ label: "ECG", data: ecgData, fill: false, lineTension: 0.1, pointRadius: 0 }]
              },
              options: {
                scales: {
                  yAxes: [{ ticks: { suggestedMin: -1.5, suggestedMax: 1.5 }}],
                  xAxes: [{ display: false }]
                },
                animation: { duration: 0 }
              }
            });
      
          } catch (err) {
            console.error("Error updating charts:", err);
          }
        }
      
        document.addEventListener('DOMContentLoaded', () => {
          fetchDataAndUpdateChart();
          setInterval(fetchDataAndUpdateChart, 5000);
        });
      </script>

</body>
</html>
