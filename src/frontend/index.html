<!DOCTYPE html>
<html lang="en">
<head>
    <title>Dashboard</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: Arial, sans-serif;
        }

        /* Header */
        .header { 
            width: 100%;
            height: 100px;
            background-color: #B3E5FC;
            color: black;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 20px;
            top: 0;
            left: 0;
           
        
        }

		 h1 {
            font-size: 30px;
            line-height: 1.3;
            display: flex;
            align-items: center;
        }
        .header h2{
        	text-decoration: none;
            border-bottom: none;
            margin-bottom: 0;
        }
        /* Content */
        .content {
            margin-top: 0px;
            padding: 0px;    
            background-color: #B3E5FC;
            color: black;
            box-shadow: 0 5px 3px black;
            
        }

        footer {
            text-align: center;
            padding: 15px;
            background-color: black;
            color: white;
            bottom: 0;
            width: 100%;
        }
        .popup{
        	position: relative;
            display: inline-block;
            cursor: pointer
        }
        .popup .popuptext {
            visibility: hidden;
            width: 160px;
            background-color: #555;
            color: #fff;
            text-align: center;
            border-radius: 6px;
            padding: 8px 0;
            position: absolute;
            z-index: 1;
            bottom: 125%;
            left: 50%;
            margin-left: -80px;
            font-size: 10px;
         }
         .popup .popuptext::after {
            content: "";
            position: absolute;
            top: 100%;
            left: 50%;
            margin-left: -5px;
            border-width: 5px;
            border-style: solid;
            border-color: #555 transparent transparent transparent;
          }
         .popup .show {
          visibility: visible;
          -webkit-animation: fadeIn 1s;
          animation: fadeIn 1s;
        }
        #myDiv {
        border: 5px solid white;
        padding: 1cm 1cm 1cm 1cm;
        box-shadow: 0px 5px 50px black;
        }
        @-webkit-keyframes fadeIn {
          from {opacity: 0;} 
          to {opacity: 1;}
        }

        @keyframes fadeIn {
          from {opacity: 0;}
          to {opacity:1 ;}
        }
        .popup-button {
            background-color: #444;
            color: white;
            border: none;
            border-radius: 50%;
            padding: 6px 6px;
            font-size: 10px;
            cursor: pointer;
            margin-left: 2px;
            display: inline-block;
            vertical-align: middle;
            line-height: 1;
            transition: background-color 0.3s ease;
        }
        .popup-button:hover {
            background-color: #666;
        }
    </style>

    <link rel="stylesheet" href="css/styles.css">
</head>

<body style="background-color: #222;">
    
    <div class="header">
        <h2>Dashboard</h2>
        <nav>
            <a href="/alerts" style="color: black; margin: 0 15px;">Alerts</a>
            <a href="/seeSettings.html" style="color: black; margin: 0 15px;">Settings</a>
        </nav>
    </div>
    <div class="content">
    <div id="myDiv">
        <h1>
        Tracking: BPM 
        <span class= "popup">
        <button class="popup-button" onclick="myFunction('popup1')">?</button>
        <span class="popuptext" id="popup1">This graph tracks heart rate. Note: Heart rate can change depending on physical activity and factors of the specific person being monitered.</span>
        </span>
        </h1>
        
        <canvas id="bpmChart" style="width:100%;max-width:700px"></canvas>
        </div>
        <div id="myDiv">
        <h1>
        Tracking: SpO2
        <span class= "popup">
        <button class="popup-button" onclick="myFunction('popup2')">?</button>
        <span class="popuptext" id="popup2">This graph tracks the oxygen content of your blood</span>
        </span>
        </h1>
        <canvas id="spo2Chart" style="width:100%;max-width:700px"></canvas>
        </div>
        <div id="myDiv">
        <h1>Tracking: ECG
        <span class= "popup">
        <button class="popup-button" onclick="myFunction('popup3')">?</button>
        <span class="popuptext" id="popup3">This graph is a live graph of the heart's electrical activity through repeated cardian cycles.</span>
        </span> </h1>
        <canvas id="ecgChart" style="width:100%;max-width:700px"></canvas>
     </div>
  	 </div>
    <footer>
        <p>Footer goes here <br> © 2025. Blah Blah All rights reserved.</p>
    </footer>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.9.4/Chart.js"></script>
    
    <script>
        function myFunction(popupId) {
    var popup = document.getElementById(popupId);
    popup.classList.toggle("show");
    }
   // Keep these arrays alive across fetches
        const maxPoints = 24;
        let timeData = [];
        let bpmData  = [];
        let spo2Data = [];
        let ecgData  = [];
      
        let bpmChartInstance = null;
        let spo2ChartInstance = null;
        let ecgChartInstance = null;
      
        async function fetchDataAndUpdateChart() {
          try {
            const patientData = JSON.parse(localStorage.getItem("patient"));
            const token       = patientData?.access_token;
            if (!token) {
              console.error("No access token found");
              return;
            }
      
            const response = await fetch('http://127.0.0.1:5000/api/vitals/', {
              headers: { 'Authorization': 'Bearer ' + token }
            });
            if (!response.ok) throw new Error(`HTTP ${response.status}`);
      
            const { timestamp, bpm, spo2, ecg } = await response.json();
      
            // Push new values onto the arrays
            timeData.push(timestamp);
            bpmData.push(bpm);
            spo2Data.push(spo2);
            ecgData.push(ecg);
      
            // Trim arrays to maxPoints
            if (timeData.length  > maxPoints) timeData.shift();
            if (bpmData.length   > maxPoints) bpmData.shift();
            if (spo2Data.length  > maxPoints) spo2Data.shift();
            if (ecgData.length   > maxPoints) ecgData.shift();
      
            // Re‑draw charts
            if (bpmChartInstance)  bpmChartInstance.destroy();
            if (spo2ChartInstance) spo2ChartInstance.destroy();
            if (ecgChartInstance)  ecgChartInstance.destroy();
      
            bpmChartInstance = new Chart("bpmChart", {
              type: "line",
              data: {
                labels: timeData,
                datasets: [{ label: "BPM", data: bpmData, fill: false, lineTension: 0.1 }]
              },
              options: { scales: { yAxes: [{ ticks: { min: 50, max: 110 }}] } }
            });
      
            spo2ChartInstance = new Chart("spo2Chart", {
              type: "line",
              data: {
                labels: timeData,
                datasets: [{ label: "SpO2 (%)", data: spo2Data, fill: false, lineTension: 0.1 }]
              },
              options: { scales: { yAxes: [{ ticks: { min: 90, max: 100 }}] } }
            });
      
            ecgChartInstance = new Chart("ecgChart", {
              type: "line",
              data: {
                labels: timeData,
                datasets: [{ label: "ECG", data: ecgData, fill: false, lineTension: 0.1, pointRadius: 0 }]
              },
              options: {
                scales: {
                  yAxes: [{ ticks: { suggestedMin: -1.5, suggestedMax: 1.5 }}],
                  xAxes: [{ display: false }]
                },
                animation: { duration: 0 }
              }
            });
      
          } catch (err) {
            console.error("Error updating charts:", err);
          }
        }
      
        document.addEventListener('DOMContentLoaded', () => {
          fetchDataAndUpdateChart();
          setInterval(fetchDataAndUpdateChart, 5000);
        });
      </script>

</body>
</html>