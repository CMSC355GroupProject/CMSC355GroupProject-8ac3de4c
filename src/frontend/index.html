<!DOCTYPE html>
<html lang="en">
<head>
    <title>Dashboard</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Document</title>
    
    <style>
       
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: Arial, sans-serif;
        }

        /* Header */
        .header { 
     
            width: 100%;
    		Height: 200px;
     		background-color: lightblue;
            color: white;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 20px;
            position: fixed;
            top: 0;
            left: 0;
        }

        /* Content */
        .content {
        	margin-top: 220px;
         
            padding: 50px;
            background-color: white;
            color: black;
        }
        footer {
        	text-align: center;
            padding: 15px;
            background-color: black;
            color: white;
            position: fixed;
            bottom: 0;
            width: 100%;
        }
    </style>

    <link rel="stylesheet" href="css/styles.css">
</head>

<body style="background-color:White;">
    
    <div class="header">
        <h2>Dashboard</h2>
        <nav> <a href="/alerts" style="color: white; margin: 0 15px;">Alerts</a>
            <a href="#" style="color: white; margin: 0 15px;">Settings</a>
        </nav>
    </div>
    <div class="content">
        <h1>Graph 1: BPM</h1>
        <canvas id="bpmChart" style="width:100%;max-width:700px"></canvas>
        
        <h1>Graph 2: SpO2</h1>
        <canvas id="spo2Chart" style="width:100%;max-width:700px"></canvas>
        
        <h1>Graph 3: ECG</h1>
        <canvas id="ecgChart" style="width:100%;max-width:700px"></canvas>
    </div>
   
    <footer>
        <p>Footer goes here <br> Â© 2025. Blah Blah All rights reserved.</p>
    </footer>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.9.4/Chart.js"></script>

<script>
let bpmChartInstance = null;
let spo2ChartInstance = null;
let ecgChartInstance = null;

async function fetchDataAndUpdateChart() {
    try {
        // Fetch data
        const response = await fetch('http://127.0.0.1:5000/api/vitals/vitals'); 
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        const data = await response.json();

        // Extract data and limit to last 24 points
        const maxPoints = 24;
        const timeLabels = data.time_data.slice(-maxPoints);
        const bpmValues = data.bpm_data.slice(-maxPoints);
        const spo2Values = data.spo2_data.slice(-maxPoints);
        
        // Get latest ECG data
        const latestEcgValues = data.ecg_data && data.ecg_data.length > 0 ? data.ecg_data[data.ecg_data.length - 1] : [];
        const ecgLabels = Array.from({ length: latestEcgValues.length }, (_, i) => i);

        // Destroy old charts
        if (bpmChartInstance) { bpmChartInstance.destroy(); }
        if (spo2ChartInstance) { spo2ChartInstance.destroy(); }
        if (ecgChartInstance) { ecgChartInstance.destroy(); }

        //BPM Chart
        bpmChartInstance = new Chart("bpmChart", {
          type: "line",
          data: {
            labels: timeLabels,
            datasets: [{
              label: "BPM",
              fill: false,
              lineTension: 0.1,
              backgroundColor: "rgba(0,0,255,1.0)",
              borderColor: "rgba(0,0,255,0.5)",
              data: bpmValues
            }]
          },
          options: {
            legend: {display: true},
            scales: {
              yAxes: [{ticks: {min: 50, max: 110}}],
            }
          }
        });

        // SpO2 Chart
        spo2ChartInstance = new Chart("spo2Chart", {
          type: "line",
          data: {
            labels: timeLabels,
            datasets: [{
              label: "SpO2 (%)",
              fill: false,
              lineTension: 0.1,
              backgroundColor: "rgba(0,255,0,1.0)",
              borderColor: "rgba(0,255,0,0.5)",
              data: spo2Values
            }]
          },
          options: {
            legend: { display: true },
            scales: {
              yAxes: [{ ticks: { min: 90, max: 100 } }]
            }
          }
        });
        
        // ECG Chart
        ecgChartInstance = new Chart("ecgChart", {
          type: "line",
          data: {
            labels: ecgLabels,
            datasets: [{
              label: "ECG",
              fill: false,
              lineTension: 0.1,
              backgroundColor: "rgba(255,0,0,1.0)",
              borderColor: "rgba(255,0,0,0.5)",
              pointRadius: 0,
              borderWidth: 1.5,
              data: latestEcgValues
            }]
          },
          options: {
            legend: { display: true },
            scales: {
              yAxes: [{ ticks: { suggestedMin: -1.5, suggestedMax: 1.5 } }],
              xAxes: [{ display: false }]
            },
            animation: {
                duration: 0
            }
          }
        });

    } catch (error) {
        console.error('Error fetching or displaying chart data:', error);
        // Show error message
        const canvas = document.getElementById('bpmChart');
        if (canvas) {
            const ctx = canvas.getContext('2d');
            ctx.font = '16px Arial';
            ctx.fillStyle = 'red';
            ctx.fillText('Error loading chart data. Check console.', 10, 50);
        }
    }
}

// Initialize
document.addEventListener('DOMContentLoaded', () => {
    fetchDataAndUpdateChart(); // First fetch
    setInterval(fetchDataAndUpdateChart, 5000); // Update every 5s
});

</script>

</body>
</html>
