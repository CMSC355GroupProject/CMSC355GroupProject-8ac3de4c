<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Alert Manager</title>
  <link rel="stylesheet" href="/css/styles.css">
  <!-- Include jwt-decode if necessary, though you won't need it for patient from localStorage -->
  <script src="https://cdn.jsdelivr.net/npm/jwt-decode@3.1.2/build/jwt-decode.min.js"></script>
</head>
<body>
  <div class="alerts-container">
    <h1>Alert Dashboard</h1>

    <!-- Create Alert Form -->
    <form id="alertForm">
      <label>
        Sensor Type
        <select name="sensor_type" required>
          <option value="ecg">ECG</option>
          <option value="spo2">SpO2</option>
          <option value="bpm">BPM</option>
        </select>
      </label>
      <label>
        Threshold Value
        <input type="number" name="threshold_value" required />
      </label>
      <label>
        Comparison
        <select name="comparison" required>
          <option value=">">Greater Than (&gt;)</option>
          <option value="<">Less Than (&lt;)</option>
          <option value="=">Equal To (=)</option>
        </select>
      </label>
      <label>
        Message
        <input type="text" name="message" required />
      </label>
      <button type="submit">Create Alert</button>
    </form>

    <!-- Alerts Table -->
    <table class="alerts-table">
      <thead>
        <tr>
          <th>Sensor</th>
          <th>Measured</th>
          <th>Threshold</th>
          <th>Cmp</th>
          <th>Message</th>
          <th>Sent?</th>
          <th>Timestamp</th>
        </tr>
      </thead>
      <tbody id="alertsBody">
        <tr><td colspan="7" style="text-align:center;">Loading alertsâ€¦</td></tr>
      </tbody>
    </table>
  </div>

  <script>
    const API = '/api/alerts/';

    // Fetch and render all alerts
    async function loadAlerts() {
      const res = await fetch(API);
      const alerts = await res.json();
      const tbody = document.getElementById('alertsBody');
      tbody.innerHTML = '';

      alerts.forEach(a => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${a.sensor_type || ''}</td>
          <td>${a.measured_value ?? ''}</td>
          <td>${a.threshold_value ?? ''}</td>
          <td>${a.comparison || ''}</td>
          <td>${a.message || ''}</td>
          <td>${a.is_sent}</td>
          <td>${a.timestamp ? new Date(a.timestamp).toLocaleString() : ''}</td>
        `;
        tbody.appendChild(tr);
      });
    }

    // Handle form submission to create a new alert
    document.getElementById('alertForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const form = e.target;

      // Retrieve the patient data from localStorage
      const patient = JSON.parse(localStorage.getItem("patient"));
      console.log('Patient ID on alerts.html: ',patient.patient_id)

      if (!patient) {
        alert('No patient data found in localStorage');
        return;
      }

      const payload = {
        patient_id: patient.patient_id,  // Use the patient_id from localStorage
        sensor_type: form.sensor_type.value,
        threshold_value: parseFloat(form.threshold_value.value),
        comparison: form.comparison.value,
        message: form.message.value
      };

      const res = await fetch(API, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
      });

      if (res.ok) {
        form.reset();
        loadAlerts();
      } else {
        alert('Failed to create alert');
      }
    });

    loadAlerts();
  </script>
</body>
</html>